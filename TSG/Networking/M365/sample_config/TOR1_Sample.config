# TOR1 Switch Configuration Sample
# M365 Azure Local Network Design - Sample Implementation
# This is a cleaned and simplified configuration for reference

# Core System Configuration
hostname TOR1-Sample
!
# VRF Configuration for Network Segmentation
ip vrf default
!
ip vrf infra_bmc_mgmt
!
# VRRP Configuration
vrrp delay reload 180
vrrp version 3
!
# Interface Breakouts (25G/100G port configuration)
interface breakout 1/1/1 map 25g-4x
interface breakout 1/1/2 map 25g-4x
interface breakout 1/1/3 map 25g-4x
interface breakout 1/1/4 map 25g-4x
interface breakout 1/1/25 map 100g-1x
interface breakout 1/1/26 map 100g-1x
interface breakout 1/1/27 map 100g-1x
interface breakout 1/1/28 map 100g-1x
interface breakout 1/1/31 map 10g-4x
interface breakout 1/1/33 map 100g-1x
!
# VLAN Interface Configuration
!
interface vlan99
 description NativeVlan
 no shutdown
!
interface vlan101
 description Edge_Transport_Management_Network
 no shutdown
 mtu 9216
 ip address 172.22.56.2/27
 !
 vrrp-group 11
  priority 150
  virtual-address 172.22.56.1
  no preempt
!
interface vlan102
 description Exchange_Mailbox_Compute_Network
 no shutdown
 mtu 9216
 ip address 192.168.0.66/26
 !
 vrrp-group 12
  priority 150
  virtual-address 192.168.0.65
  no preempt
!
interface vlan125
 description Out_of_Band_Management_BMC
 no shutdown
 mtu 9216
 ip vrf forwarding infra_bmc_mgmt
 ip address 10.60.48.131/26
 !
 vrrp-group 125
  priority 150
  virtual-address 10.60.48.129
  no preempt
!
interface vlan201
 description SharePoint_MSU_Management_Network
 no shutdown
 mtu 9216
 ip address 172.22.56.34/27
 !
 vrrp-group 21
  priority 150
  virtual-address 172.22.56.33
  no preempt
!
interface vlan203
 description Edge_Transport_Compute_Network
 no shutdown
 mtu 9216
 ip address 192.168.0.130/26
 !
 vrrp-group 23
  priority 150
  virtual-address 192.168.0.129
  no preempt
!
interface vlan301
 description Exchange_Mailbox_Management_Network
 no shutdown
 mtu 9216
 ip address 172.22.56.66/26
 !
 vrrp-group 31
  priority 150
  virtual-address 172.22.56.65
  no preempt
!
interface vlan302
 description SharePoint_MSU_Compute_Network
 no shutdown
 mtu 9216
 ip address 192.168.0.2/26
 !
 vrrp-group 32
  priority 150
  virtual-address 192.168.0.1
  no preempt
!
interface vlan400
 description iBGP_Point_to_Point_Compute
 no shutdown
 ip address 192.168.0.193/30
!
interface vlan401
 description iBGP_Point_to_Point_Default
 no shutdown
 ip address 172.22.56.129/30
!
interface vlan402
 description Infrastructure_Management
 no shutdown
 ip vrf forwarding infra_bmc_mgmt
 ip address 172.22.57.2/28
 !
 vrrp-group 42
  priority 150
  virtual-address 172.22.57.1
  no preempt
!
interface vlan500
 description DMZ-LoadBalancer-to-Firewall
 no shutdown
 ip address 192.168.100.2/28
!
# Server Port Configuration Examples
!
# SharePoint/MSU Cluster Nodes - Ports 1.1-1.3
# Management VLAN 201 (untagged) | Compute VLANs: 102 (Exchange), 302 (SharePoint)
interface ethernet1/1/1:1
 description SharePoint_Node1_MSU_Cluster
 no shutdown
 switchport mode trunk
 switchport access vlan 201
 switchport trunk allowed vlan 102,302
 mtu 9216
 spanning-tree port type edge
!
interface ethernet1/1/1:2
 description SharePoint_Node2_MSU_Cluster
 no shutdown
 switchport mode trunk
 switchport access vlan 201
 switchport trunk allowed vlan 102,302
 mtu 9216
 spanning-tree port type edge
!
interface ethernet1/1/1:3
 description SharePoint_Node3_MSU_Cluster
 no shutdown
 switchport mode trunk
 switchport access vlan 201
 switchport trunk allowed vlan 102,302
 mtu 9216
 spanning-tree port type edge
!
# Exchange Mailbox Nodes - Ports 1.4-2.3
# Management VLAN 301 (untagged) | Compute VLANs: 102, 203, 302 | Management: 201
interface ethernet1/1/1:4
 description Exchange_Mailbox_Node1
 no shutdown
 switchport mode trunk
 switchport access vlan 301
 switchport trunk allowed vlan 102,201,203,302
 mtu 9216
 spanning-tree port type edge
!
interface ethernet1/1/2:1
 description Exchange_Mailbox_Node2
 no shutdown
 switchport mode trunk
 switchport access vlan 301
 switchport trunk allowed vlan 102,201,203,302
 mtu 9216
 spanning-tree port type edge
!
# Edge Transport Nodes - Ports 2.4-3.1
# Management VLAN 101 (untagged) | Compute VLANs: 102, 203, 302 | Management: 201
interface ethernet1/1/2:4
 description Edge_Transport_Node1
 no shutdown
 switchport mode trunk
 switchport access vlan 101
 switchport trunk allowed vlan 102,201,203,302
 mtu 9216
 spanning-tree port type edge
!
interface ethernet1/1/3:1
 description Edge_Transport_Node2
 no shutdown
 switchport mode trunk
 switchport access vlan 101
 switchport trunk allowed vlan 102,201,203,302
 mtu 9216
 spanning-tree port type edge
!
# Infrastructure Nodes
!
# Hyper-V Host for Virtual Infrastructure (Node 11)
# This port connects to the Hyper-V host running BOTH virtual appliances:
#   - Palo Alto Firewall VM: Handles internet security (DMZ VLAN 500 only)
#   - F5 Load Balancer VM: Connects DMZ to production VLANs (102, 203, 302, 500)
#
# VLAN Trunk Purpose:
#   - VLAN 102: Exchange Mailbox compute network
#   - VLAN 203: Edge Transport compute network  
#   - VLAN 302: SharePoint/MSU compute network
#   - VLAN 500: DMZ layer 2 segment (Firewall <-> Load Balancer on same host)
#
# Note: Both VMs communicate via VLAN 500 on the same Hyper-V host (no physical cable)
interface ethernet1/1/3:2
 description Hyper-V_Node11_Virtual_Firewall_and_LoadBalancer
 no shutdown
 switchport mode trunk
 switchport access vlan 1
 switchport trunk allowed vlan 102,203,302,500
 mtu 9216
 spanning-tree port type edge
!
# Port Channel Configuration (MLAG/VLT)
!
interface port-channel50
 description PEER_TRUNK
 no shutdown
 switchport mode trunk
 switchport access vlan 99
 mtu 9216
!
interface port-channel102
 description VLTi:TOR_BMC
 no shutdown
 switchport mode trunk
 switchport access vlan 99
 switchport trunk allowed vlan 125
 vlt-port-channel 102
!
# VLT Peer Link Configuration
interface ethernet1/1/25
 description PEER_TRUNK
 no shutdown
 channel-group 50 mode active
 no switchport
 mtu 9216
!
interface ethernet1/1/26
 description PEER_TRUNK
 no shutdown
 channel-group 50 mode active
 no switchport
 mtu 9216
!
interface ethernet1/1/27
 description VLT_PEER
 no shutdown
 no switchport
 mtu 9216
!
interface ethernet1/1/28
 description VLT_PEER
 no shutdown
 no switchport
 mtu 9216
!
# Uplink Configuration
interface ethernet1/1/31:1
 description TOR1-to-CORE
 no shutdown
 no switchport
 mtu 9216
 ip vrf forwarding infra_bmc_mgmt
 ip address 172.22.56.133/31
!
# BMC Switch Connection
interface ethernet1/1/33
 description Trunk_TO_BMC_SWITCH
 no shutdown
 channel-group 102 mode active
 no switchport
 mtu 9216
!
# Loopback Interface
interface loopback0
 description Loopback0_Tor1
 no shutdown
 ip address 172.22.56.136/32
!
# Routing Configuration
!
# Default Route to Firewall
ip route 0.0.0.0/0 192.168.100.1
!
# BGP Configuration
# ASN 65001: Private ASN for M365 Azure Local infrastructure
# This example uses iBGP between TOR switches and eBGP to upstream core
router bgp 65001
 bestpath as-path multipath-relax
 maximum-paths ebgp 8
 maximum-paths ibgp 8
 router-id 172.22.56.136
 !
 address-family ipv4 unicast
  network 192.168.100.0/28
  network 172.22.56.0/27
  network 172.22.56.64/26
  network 172.22.56.96/27
  network 192.168.0.0/26
  network 192.168.0.128/26
  network 192.168.0.192/30
  network 192.168.0.64/26
 !
 neighbor 192.168.0.194
  description iBGP_Peer_to_TOR2_Compute_Network
  remote-as 65001
  no shutdown
 !
 vrf infra_bmc_mgmt
  !
  address-family ipv4 unicast
   network 172.22.56.128/30
   network 172.22.56.132/31
   network 172.22.57.0/28
   network 10.60.48.128/26
  !
  neighbor 172.22.56.132
   description eBGP_Uplink_to_Core_Switch
   remote-as 65000
   no shutdown
!
# VLT Domain Configuration
vlt-domain 1
 backup destination 192.168.0.194
 discovery-interface ethernet1/1/27-1/1/28
 peer-routing
 primary-priority 1
 vlt-mac de:ad:00:be:ef:01