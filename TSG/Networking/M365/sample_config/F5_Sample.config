# F5 BIG-IP Load Balancer Configuration Sample
# M365 Azure Local Network Design - Sample Implementation
# F5 BIG-IP VE Configuration for Exchange, SharePoint, and Edge Transport
# This is a cleaned and simplified configuration for reference

# ============================================================================
# SECTION 1: NETWORK INTERFACE CONFIGURATION
# ============================================================================
# Purpose: Define physical/virtual interfaces for VLAN attachment
# Note: Adjust MTU to 9198 for jumbo frames on compute networks

# Interface 1.1 - Exchange Mailbox Compute Network (VLAN 102)
net interface 1.1 {
    description "Exchange_Mailbox_Compute_Network_VLAN102"
    media-max 25000-FD
}

# Interface 1.2 - Edge Transport Compute Network (VLAN 203)
net interface 1.2 {
    description "Edge_Transport_Compute_Network_VLAN203"
    media-max 25000-FD
    mtu 9198
}

# Interface 1.3 - SharePoint/MSU Compute Network (VLAN 302)
net interface 1.3 {
    description "SharePoint_MSU_Compute_Network_VLAN302"
    media-max 25000-FD
    mtu 9198
}

# Interface 1.4 - DMZ to Firewall (VLAN 500)
net interface 1.4 {
    description "DMZ_LoadBalancer_to_Firewall_VLAN500"
    media-max 25000-FD
    mtu 9198
}

# ============================================================================
# SECTION 2: VLAN CONFIGURATION
# ============================================================================
# Purpose: Create VLANs and bind to physical interfaces
# Aligns with M365-IPAssignment_Sample.json network definitions

# VLAN 102 - Exchange Mailbox Compute (192.168.0.64/26)
create net vlan csu-exchange-compute {
    description "Exchange_Mailbox_Compute_Network"
    tag 102
    interfaces {
        1.1 { }
    }
}

# VLAN 203 - Edge Transport Compute (192.168.0.0/26)
create net vlan csu-edge-transport-compute {
    description "Edge_Transport_Compute_Network"
    tag 203
    interfaces {
        1.2 { }
    }
    mtu 9198
}

# VLAN 302 - SharePoint/MSU Compute (192.168.0.128/26)
create net vlan msu-compute {
    description "SharePoint_MSU_Compute_Network"
    tag 302
    interfaces {
        1.3 { }
    }
    mtu 9198
}

# VLAN 500 - DMZ to Palo Alto Firewall (192.168.100.0/28)
create net vlan DMZ-LoadBalancer-to-Firewall {
    description "DMZ_to_Firewall_Network"
    tag 500
    interfaces {
        1.4 { }
    }
}

# ============================================================================
# SECTION 3: SELF-IP CONFIGURATION
# ============================================================================
# Purpose: F5 interface IPs for each VLAN (acts as gateway alternative)
# These IPs allow F5 to route/load-balance traffic between networks

# Self-IP for VLAN 102 - Exchange Mailbox Network
create net self CSUExchange-192.168.0.68 {
    address 192.168.0.68/26
    vlan csu-exchange-compute
    allow-service default
    traffic-group traffic-group-local-only
}

# Self-IP for VLAN 203 - Edge Transport Network
create net self CSUEdgeTransport-192.168.0.4 {
    address 192.168.0.4/26
    vlan csu-edge-transport-compute
    allow-service default
    traffic-group traffic-group-local-only
}

# Self-IP for VLAN 302 - SharePoint/MSU Network
create net self MSU-SharePointVIP1-192.168.0.132 {
    address 192.168.0.132/26
    vlan msu-compute
    allow-service default
    traffic-group traffic-group-local-only
}

# Self-IP for VLAN 500 - DMZ to Firewall
# This IP communicates with Palo Alto firewall (192.168.100.1)
create net self DMZIP-192.168.100.2 {
    address 192.168.100.2/28
    vlan DMZ-LoadBalancer-to-Firewall
    allow-service default
    traffic-group traffic-group-local-only
}

# ============================================================================
# SECTION 4: ROUTING CONFIGURATION
# ============================================================================
# Purpose: Default routes and static routes for external connectivity
# Note: Connected routes are automatically created for Self-IP subnets

# Static routes can be added if needed for routing to other networks
# Example (commented out - add only if required):
# create net route to-backend {
#     network 192.168.10.0/24
#     gw 192.168.0.1
# }

# ============================================================================
# SECTION 5: HEALTH MONITORS
# ============================================================================
# Purpose: Define health checks to monitor backend server availability
# F5 will only send traffic to servers passing health checks

# Monitor: Exchange OWA Health (HTTPS)
create ltm monitor https MailboxExchange_OWA_Health_HTTPS {
    defaults-from https
    description "Exchange_OWA_Healthcheck"
    send "GET /owa/healthcheck.htm\r\n"
    recv "OK"
    interval 5
    timeout 16
}

# Monitor: Exchange Autodiscover Health (HTTPS)
create ltm monitor https MailboxExchange_Autodiscover_Health_HTTPS {
    defaults-from https
    description "Exchange_Autodiscover_Healthcheck"
    send "GET /autodiscover/healthcheck.htm\r\n"
    interval 5
    timeout 16
}

# Monitor: Exchange ActiveSync Health (HTTPS)
create ltm monitor https MailboxExchange_EAS_Health_HTTPS {
    defaults-from https
    description "Exchange_ActiveSync_Healthcheck"
    send "GET /Microsoft-Server-ActiveSync/healthcheck.htm\r\n"
    interval 5
    timeout 16
}

# Monitor: Exchange EWS Health (HTTPS)
create ltm monitor https MailboxExchange_EWS_Health_HTTPS {
    defaults-from https
    description "Exchange_WebServices_Healthcheck"
    send "GET /ews/healthcheck.htm\r\n"
    interval 5
    timeout 16
}

# Monitor: Exchange MAPI Health (HTTPS)
create ltm monitor https MailboxExchange_MAPI_Health_HTTPS {
    defaults-from https
    description "Exchange_MAPI_Healthcheck"
    send "GET /mapi/healthcheck.htm\r\n"
    interval 5
    timeout 16
}

# Monitor: Exchange OAB Health (HTTPS)
create ltm monitor https MailboxExchange_OAB_Health_HTTPS {
    defaults-from https
    description "Exchange_OfflineAddressBook_Healthcheck"
    send "GET /oab/healthcheck.htm\r\n"
    interval 5
    timeout 16
}

# Monitor: Exchange ECP Health (HTTPS)
create ltm monitor https MailboxExchange_ECP_Health_HTTPS {
    defaults-from https
    description "Exchange_ControlPanel_Healthcheck"
    send "GET /ecp/healthcheck.htm\r\n"
    interval 5
    timeout 16
}

# Monitor: IMAP Secure (Port 993 over HTTPS)
create ltm monitor https IMAP_993_HTTPS {
    defaults-from https
    description "IMAP_Secure_Port_993"
    destination *.imaps
    send "GET /\r\n"
    interval 5
    timeout 16
}

# Monitor: POP3 Secure (Port 995 over HTTPS)
create ltm monitor https POP3_995_HTTPS {
    defaults-from https
    description "POP3_Secure_Port_995"
    destination *.pop3s
    send "GET /\r\n"
    interval 5
    timeout 16
}

# Monitor: IMAP with TLS (Port 143)
create ltm monitor tcp IMAP_143_TLS {
    defaults-from tcp
    description "IMAP_Port_143_TLS"
    destination *.imap
    recv "\\* OK The Microsoft Exchange IMAP4 service is ready."
    interval 5
    timeout 16
}

# Monitor: POP3 (Port 110)
create ltm monitor tcp POP3 {
    defaults-from tcp
    description "POP3_Port_110"
    destination *.pop3
    recv "\\+OK The Microsoft Exchange POP3 service is ready."
    interval 5
    timeout 16
}

# Monitor: SMTP with Domain Check (Port 25/587)
create ltm monitor smtp SMTP_587_DOMAIN {
    defaults-from smtp
    description "SMTP_with_Domain_Verification"
    domain m365locallab.com
    interval 5
    timeout 16
}

# Monitor: SMTP Basic Check (Port 25/587)
create ltm monitor smtp SMTP_587_BASIC {
    defaults-from smtp
    description "SMTP_Basic_Check"
    interval 30
    timeout 91
}

# ============================================================================
# SECTION 6: NODE CONFIGURATION
# ============================================================================
# Purpose: Define backend servers (nodes) that will receive load-balanced traffic
# IP addresses align with M365-IPAssignment_Sample.json

# Edge Transport Servers (VLAN 203)
create ltm node EdgeTransportServer1 {
    address 192.168.0.9
    description "Edge_Transport_Server_1"
}

create ltm node EdgeTransportServer2 {
    address 192.168.0.11
    description "Edge_Transport_Server_2"
}

# Exchange Mailbox Servers (VLAN 102)
create ltm node Mailbox1 {
    address 192.168.0.73
    description "Exchange_Mailbox_Server_1"
}

create ltm node Mailbox2 {
    address 192.168.0.75
    description "Exchange_Mailbox_Server_2"
}

create ltm node Mailbox3 {
    address 192.168.0.77
    description "Exchange_Mailbox_Server_3"
}

create ltm node Mailbox4 {
    address 192.168.0.79
    description "Exchange_Mailbox_Server_4"
}

# SharePoint Front-End Servers (VLAN 302)
create ltm node SharePointFE1 {
    address 192.168.0.143
    description "SharePoint_Frontend_Server_1"
}

create ltm node SharePointFE2 {
    address 192.168.0.144
    description "SharePoint_Frontend_Server_2"
}

# ============================================================================
# SECTION 7: POOL CONFIGURATION
# ============================================================================
# Purpose: Group nodes into pools for load balancing with health monitoring
# Uses least-connections algorithm for optimal distribution

# Pool: Exchange Mailbox OWA (HTTPS Port 443)
# Comprehensive Exchange health monitoring for all services
create ltm pool Mailbox_OWA_443 {
    description "Exchange_OWA_HTTPS_Pool"
    load-balancing-mode least-connections-member
    members add {
        Mailbox1:https { address 192.168.0.73 }
        Mailbox2:https { address 192.168.0.75 }
        Mailbox3:https { address 192.168.0.77 }
        Mailbox4:https { address 192.168.0.79 }
    }
    monitor MailboxExchange_Autodiscover_Health_HTTPS and MailboxExchange_EAS_Health_HTTPS and MailboxExchange_ECP_Health_HTTPS and MailboxExchange_EWS_Health_HTTPS and MailboxExchange_MAPI_Health_HTTPS and MailboxExchange_OAB_Health_HTTPS and MailboxExchange_OWA_Health_HTTPS
}

# Pool: Exchange IMAP Secure (Port 993)
create ltm pool Mailbox_IMAP_993_HTTPS {
    description "Exchange_IMAP_Secure_Port_993"
    load-balancing-mode least-connections-member
    members add {
        Mailbox1:imaps { address 192.168.0.73 }
        Mailbox2:imaps { address 192.168.0.75 }
        Mailbox3:imaps { address 192.168.0.77 }
        Mailbox4:imaps { address 192.168.0.79 }
    }
    monitor IMAP_993_HTTPS
}

# Pool: Exchange IMAP with TLS (Port 143)
create ltm pool Mailbox_IMAP_143_PORT {
    description "Exchange_IMAP_TLS_Port_143"
    load-balancing-mode least-connections-member
    members add {
        Mailbox1:imap { address 192.168.0.73 }
        Mailbox2:imap { address 192.168.0.75 }
        Mailbox3:imap { address 192.168.0.77 }
        Mailbox4:imap { address 192.168.0.79 }
    }
    monitor IMAP_143_TLS
}

# Pool: Exchange POP3 (Port 110)
create ltm pool Mailbox_POP_110 {
    description "Exchange_POP3_Port_110"
    load-balancing-mode least-connections-member
    members add {
        Mailbox1:pop3 { address 192.168.0.73 }
        Mailbox2:pop3 { address 192.168.0.75 }
        Mailbox3:pop3 { address 192.168.0.77 }
        Mailbox4:pop3 { address 192.168.0.79 }
    }
    monitor POP3
}

# Pool: Exchange POP3 Secure (Port 995)
create ltm pool Mailbox_POP3_995_HTTPS {
    description "Exchange_POP3_Secure_Port_995"
    load-balancing-mode least-connections-member
    members add {
        Mailbox1:pop3s { address 192.168.0.73 }
        Mailbox2:pop3s { address 192.168.0.75 }
        Mailbox3:pop3s { address 192.168.0.77 }
        Mailbox4:pop3s { address 192.168.0.79 }
    }
    monitor POP3_995_HTTPS
}

# Pool: Edge Transport SMTP (Port 25)
create ltm pool EdgeTransport_25_SMTP_DOMAIN {
    description "Edge_Transport_SMTP_Port_25"
    load-balancing-mode least-connections-member
    members add {
        EdgeTransportServer1:smtp { address 192.168.0.9 }
        EdgeTransportServer2:smtp { address 192.168.0.11 }
    }
    monitor SMTP_587_DOMAIN
}

# Pool: SharePoint Frontend HTTPS (Port 443)
create ltm pool SharePoint_443_HTTPS {
    description "SharePoint_Frontend_HTTPS_Pool"
    load-balancing-mode least-connections-member
    members add {
        SharePointFE1:https { address 192.168.0.143 }
        SharePointFE2:https { address 192.168.0.144 }
    }
    monitor https
}

# ============================================================================
# SECTION 8: VIRTUAL SERVER CONFIGURATION
# ============================================================================
# Purpose: Define Virtual IPs (VIPs) that clients connect to
# Traffic to VIPs is distributed across backend pool members
# Two VIPs per service: Internal (compute network) and External (DMZ to firewall)

# Virtual IP Addresses (from M365-IPAssignment_Sample.json):
# - 192.168.100.3: Mailbox VIP (External/DMZ)
# - 192.168.100.4: Edge Transport VIP (External/DMZ)
# - 192.168.100.5: SharePoint VIP (External/DMZ)
# - 192.168.0.68: Mailbox VIP (Internal)
# - 192.168.0.132: SharePoint VIP (Internal)

# Virtual Server: Exchange OWA HTTPS (External - DMZ)
create ltm virtual Mailbox_OWA_443_External {
    destination 192.168.100.3:https
    pool Mailbox_OWA_443
    profiles {
        tcp { }
    }
    source-address-translation {
        type automap
    }
    description "Exchange_OWA_External_VIP"
}

# Virtual Server: Exchange OWA HTTPS (Internal)
create ltm virtual Mailbox_OWA_443_Internal {
    destination 192.168.0.68:https
    pool Mailbox_OWA_443
    profiles {
        tcp { }
    }
    source-address-translation {
        type automap
    }
    description "Exchange_OWA_Internal_VIP"
}

# Virtual Server: Exchange IMAP Secure 993 (External - DMZ)
create ltm virtual Mailbox_IMAP_993_External {
    destination 192.168.100.3:imaps
    pool Mailbox_IMAP_993_HTTPS
    profiles {
        tcp { }
    }
    source-address-translation {
        type automap
    }
    description "Exchange_IMAP_993_External_VIP"
}

# Virtual Server: Exchange IMAP Secure 993 (Internal)
create ltm virtual Mailbox_IMAP_993_Internal {
    destination 192.168.0.68:imaps
    pool Mailbox_IMAP_993_HTTPS
    profiles {
        tcp { }
    }
    source-address-translation {
        type automap
    }
    description "Exchange_IMAP_993_Internal_VIP"
}

# Virtual Server: Exchange IMAP TLS 143 (External - DMZ)
create ltm virtual Mailbox_IMAP_143_External {
    destination 192.168.100.3:imap
    pool Mailbox_IMAP_143_PORT
    profiles {
        tcp { }
    }
    source-address-translation {
        type automap
    }
    description "Exchange_IMAP_143_External_VIP"
}

# Virtual Server: Exchange IMAP TLS 143 (Internal)
create ltm virtual Mailbox_IMAP_143_Internal {
    destination 192.168.0.68:imap
    pool Mailbox_IMAP_143_PORT
    profiles {
        tcp { }
    }
    source-address-translation {
        type automap
    }
    description "Exchange_IMAP_143_Internal_VIP"
}

# Virtual Server: Exchange POP3 110 (External - DMZ)
create ltm virtual Mailbox_POP3_110_External {
    destination 192.168.100.3:pop3
    pool Mailbox_POP_110
    profiles {
        tcp { }
    }
    source-address-translation {
        type automap
    }
    description "Exchange_POP3_110_External_VIP"
}

# Virtual Server: Exchange POP3 110 (Internal)
create ltm virtual Mailbox_POP3_110_Internal {
    destination 192.168.0.68:pop3
    pool Mailbox_POP_110
    profiles {
        tcp { }
    }
    source-address-translation {
        type automap
    }
    description "Exchange_POP3_110_Internal_VIP"
}

# Virtual Server: Exchange POP3 Secure 995 (External - DMZ)
create ltm virtual Mailbox_POP3_995_External {
    destination 192.168.100.3:pop3s
    pool Mailbox_POP3_995_HTTPS
    profiles {
        tcp { }
    }
    source-address-translation {
        type automap
    }
    description "Exchange_POP3_995_External_VIP"
}

# Virtual Server: Exchange POP3 Secure 995 (Internal)
create ltm virtual Mailbox_POP3_995_Internal {
    destination 192.168.0.68:pop3s
    pool Mailbox_POP3_995_HTTPS
    profiles {
        tcp { }
    }
    source-address-translation {
        type automap
    }
    description "Exchange_POP3_995_Internal_VIP"
}

# Virtual Server: Edge Transport SMTP 25 (External - DMZ)
create ltm virtual Mailbox_SMTP_25_External {
    destination 192.168.100.4:smtp
    pool EdgeTransport_25_SMTP_DOMAIN
    profiles {
        tcp { }
    }
    source-address-translation {
        type automap
    }
    description "Edge_Transport_SMTP_External_VIP"
}

# Virtual Server: Edge Transport SMTP 25 (Internal)
create ltm virtual Mailbox_SMTP_25_Internal {
    destination 192.168.0.68:smtp
    pool EdgeTransport_25_SMTP_DOMAIN
    profiles {
        tcp { }
    }
    source-address-translation {
        type automap
    }
    description "Edge_Transport_SMTP_Internal_VIP"
}

# Virtual Server: SharePoint HTTPS 443 (External - DMZ)
create ltm virtual SharePoint_FE_443_External {
    destination 192.168.100.5:https
    pool SharePoint_443_HTTPS
    profiles {
        tcp { }
    }
    persist {
        dest_addr {
            default yes
        }
    }
    source-address-translation {
        type automap
    }
    description "SharePoint_HTTPS_External_VIP"
}

# Virtual Server: SharePoint HTTPS 443 (Internal)
create ltm virtual SharePoint_FE_443_Internal {
    destination 192.168.0.132:https
    pool SharePoint_443_HTTPS
    profiles {
        tcp { }
    }
    persist {
        dest_addr {
            default yes
        }
    }
    source-address-translation {
        type automap
    }
    description "SharePoint_HTTPS_Internal_VIP"
}

# ============================================================================
# SAVE CONFIGURATION
# ============================================================================
save sys config

# ============================================================================
# CONFIGURATION NOTES AND DEPLOYMENT GUIDANCE
# ============================================================================

# 1. IP Address Alignment:
#    All IP addresses align with M365-IPAssignment_Sample.json
#    - VLAN 102: 192.168.0.64/26 (Exchange Mailbox)
#    - VLAN 203: 192.168.0.0/26 (Edge Transport)
#    - VLAN 302: 192.168.0.128/26 (SharePoint/MSU)
#    - VLAN 500: 192.168.100.0/28 (DMZ to Firewall)
#
# 2. Virtual IP Strategy:
#    - External VIPs (192.168.100.x): Accessed via Palo Alto firewall from internet
#    - Internal VIPs (192.168.0.x): Direct access from internal networks
#    - Firewall NATs public IPs to external VIPs
#    - F5 load-balances to backend servers
#
# 3. Traffic Flow:
#    Internet → Palo Alto (64.124.41.198) → F5 DMZ VIP (192.168.100.x) → Backend Servers
#    Internal → F5 Internal VIP (192.168.0.x) → Backend Servers
#
# 4. Health Monitoring:
#    - Exchange: Comprehensive health checks for all services (OWA, EWS, MAPI, etc.)
#    - SMTP: Domain verification and basic connectivity checks
#    - IMAP/POP3: Protocol-specific health checks
#    - SharePoint: Standard HTTPS monitoring
#
# 5. Load Balancing Algorithm:
#    - Using "least-connections-member" for optimal distribution
#    - Consider "round-robin" for simpler environments
#    - SharePoint includes destination address persistence for session affinity
#
# 6. High Availability:
#    - This is a single F5 configuration
#    - For production, deploy in HA pair (Active/Standby or Active/Active)
#    - Configure traffic-group-1 for floating VIPs in HA setup
#    - Use VRRP or config sync between HA peers
#
# 7. Hyper-V Integration Notes:
#    - F5 VE requires trunk configuration on Hyper-V vSwitch
#    - Ensure all VLANs (102, 203, 302, 500) are trunked to VM
#    - PowerShell example:
#      Set-VMNetworkAdapterVlan -VMName "F5-VE" -Trunk -AllowedVlanIdList "102,203,302,500"
#
# 8. Performance Tuning:
#    - MTU set to 9198 for jumbo frames on compute networks
#    - Adjust health check intervals based on environment stability
#    - Monitor connection limits and adjust as needed
#    - Consider FastL4 profile for better performance (Layer 4 only)
#
# 9. Security Considerations:
#    - Allow-service set to "default" (management access)
#    - Restrict to specific IPs in production: allow-service { 172.22.57.0/24 }
#    - Enable logging for security auditing
#    - Consider SSL offloading for HTTPS services
#
# 10. Troubleshooting Commands:
#     - Check VLAN status: show net vlan
#     - Check pool member status: show ltm pool members
#     - Check virtual server status: show ltm virtual
#     - View connections: show sys connection
#     - Packet capture: tcpdump -ni 1.1 -e
#     - View routes: show net route

# End of Configuration
