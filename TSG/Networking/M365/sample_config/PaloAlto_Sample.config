# Palo Alto Firewall Configuration Sample
# M365 Azure Local Network Design - Sample Implementation
# VM-Series Virtual Firewall Configuration
# This is a cleaned and simplified configuration for reference

# ============================================================================
# System Configuration
# ============================================================================

# Basic System Settings
set deviceconfig system hostname PaloAlto-Firewall-Sample
set deviceconfig system timezone US/Pacific
set deviceconfig system ip-address 172.22.57.6
set deviceconfig system netmask 255.255.255.240
set deviceconfig system default-gateway 172.22.57.1
set deviceconfig system dns-setting servers primary 1.1.1.1

# Security Hardening
set deviceconfig system service disable-telnet yes
set deviceconfig system service disable-http yes

# ============================================================================
# Network Interface Configuration
# ============================================================================

# Interface ethernet1/1 - DMZ Zone (connects to F5 Load Balancer via VLAN 500)
# Purpose: Internal-facing interface for communication with F5 Load Balancer
# Network: 192.168.100.0/28 (DMZ subnet)
set network interface ethernet ethernet1/1 comment "DMZ_to_LoadBalancer_VLAN500"
set network interface ethernet ethernet1/1 layer3 ip 192.168.100.1/28
set network interface ethernet ethernet1/1 layer3 lldp enable no

# Interface ethernet1/2 - Internet Zone (WAN connection)
# Purpose: External-facing interface for public internet connectivity
# Network: 64.124.41.192/29 (Public IP block)
# Note: Replace with your actual public IP block
set network interface ethernet ethernet1/2 comment "Internet_WAN_Connection"
set network interface ethernet ethernet1/2 layer3 ip 64.124.41.197/29
set network interface ethernet ethernet1/2 layer3 lldp enable no

# ============================================================================
# Virtual Router Configuration
# ============================================================================

# Virtual Router - Default
# Interfaces: ethernet1/1 (DMZ), ethernet1/2 (Internet)
set network virtual-router default interface [ ethernet1/1 ethernet1/2 ]
set network virtual-router default ecmp algorithm ip-modulo

# Static Routes
# Default route to internet gateway
set network virtual-router default routing-table ip static-route Default-Route destination 0.0.0.0/0
set network virtual-router default routing-table ip static-route Default-Route nexthop ip-address 64.124.41.193
set network virtual-router default routing-table ip static-route Default-Route interface ethernet1/2
set network virtual-router default routing-table ip static-route Default-Route metric 10
set network virtual-router default routing-table ip static-route Default-Route route-table unicast

# Route to Azure Local Management Networks (via F5 Load Balancer)
set network virtual-router default routing-table ip static-route Management-Networks destination 172.22.56.0/24
set network virtual-router default routing-table ip static-route Management-Networks nexthop ip-address 192.168.100.2
set network virtual-router default routing-table ip static-route Management-Networks interface ethernet1/1
set network virtual-router default routing-table ip static-route Management-Networks metric 10
set network virtual-router default routing-table ip static-route Management-Networks route-table unicast

# Route to Azure Local Compute Networks (via F5 Load Balancer)
set network virtual-router default routing-table ip static-route Compute-Networks destination 192.168.0.0/24
set network virtual-router default routing-table ip static-route Compute-Networks nexthop ip-address 192.168.100.2
set network virtual-router default routing-table ip static-route Compute-Networks interface ethernet1/1
set network virtual-router default routing-table ip static-route Compute-Networks metric 10
set network virtual-router default routing-table ip static-route Compute-Networks route-table unicast

# ============================================================================
# Security Zones
# ============================================================================

# DMZ Zone (Internal - connects to F5 Load Balancer)
set zone DMZ network layer3 ethernet1/1

# Internet Zone (External - public internet)
set zone Internet network layer3 ethernet1/2

# ============================================================================
# Service Objects
# ============================================================================

# Custom Services for M365 Applications
set service SMTP protocol tcp port 25
set service SMTP protocol tcp override no

set service IMAP protocol tcp port 993
set service IMAP protocol tcp override no

set service IMAP-TLS protocol tcp port 143
set service IMAP-TLS protocol tcp override no

set service POP3 protocol tcp port 110
set service POP3 protocol tcp override no

set service POP3-Secure protocol tcp port 995
set service POP3-Secure protocol tcp override no

set service SharePoint-HTTPS protocol tcp port 444
set service SharePoint-HTTPS protocol tcp override no

# ============================================================================
# Address Objects
# ============================================================================

# Public IP for published services (replace with your actual public IP)
set address Public-Service-IP ip-netmask 64.124.41.198

# DMZ Network
set address DMZ-Network ip-netmask 192.168.100.0/28

# F5 Load Balancer Virtual IPs (in DMZ VLAN 500)
set address F5-VIP-Mailbox ip-netmask 192.168.100.3
set address F5-VIP-EdgeTransport ip-netmask 192.168.100.4
set address F5-VIP-SharePoint ip-netmask 192.168.100.5

# ============================================================================
# NAT Policy
# ============================================================================

# Outbound NAT - DMZ to Internet (for servers to access internet)
set rulebase nat rules Outbound-NAT source-translation dynamic-ip-and-port interface-address interface ethernet1/2
set rulebase nat rules Outbound-NAT source-translation dynamic-ip-and-port interface-address ip 64.124.41.197/29
set rulebase nat rules Outbound-NAT to Internet
set rulebase nat rules Outbound-NAT from DMZ
set rulebase nat rules Outbound-NAT source any
set rulebase nat rules Outbound-NAT destination any
set rulebase nat rules Outbound-NAT service any

# Inbound NAT Rules - Internet to M365 Services
# NAT public IP to F5 Load Balancer VIPs in DMZ

# Exchange SMTP (Port 25) - Email submission
set rulebase nat rules Inbound-SMTP destination-translation translated-address 192.168.100.4
set rulebase nat rules Inbound-SMTP destination-translation translated-port 25
set rulebase nat rules Inbound-SMTP to Internet
set rulebase nat rules Inbound-SMTP from Internet
set rulebase nat rules Inbound-SMTP source any
set rulebase nat rules Inbound-SMTP destination 64.124.41.198
set rulebase nat rules Inbound-SMTP service SMTP
set rulebase nat rules Inbound-SMTP to-interface ethernet1/2
set rulebase nat rules Inbound-SMTP disabled no

# Outlook Web Access / HTTPS (Port 443)
set rulebase nat rules Inbound-OWA destination-translation translated-address 192.168.100.3
set rulebase nat rules Inbound-OWA destination-translation translated-port 443
set rulebase nat rules Inbound-OWA to Internet
set rulebase nat rules Inbound-OWA from Internet
set rulebase nat rules Inbound-OWA source any
set rulebase nat rules Inbound-OWA destination 64.124.41.198
set rulebase nat rules Inbound-OWA service service-https
set rulebase nat rules Inbound-OWA to-interface ethernet1/2
set rulebase nat rules Inbound-OWA disabled no

# IMAP Secure (Port 993)
set rulebase nat rules Inbound-IMAP destination-translation translated-address 192.168.100.3
set rulebase nat rules Inbound-IMAP destination-translation translated-port 993
set rulebase nat rules Inbound-IMAP to Internet
set rulebase nat rules Inbound-IMAP from Internet
set rulebase nat rules Inbound-IMAP source any
set rulebase nat rules Inbound-IMAP destination 64.124.41.198
set rulebase nat rules Inbound-IMAP service IMAP
set rulebase nat rules Inbound-IMAP to-interface ethernet1/2
set rulebase nat rules Inbound-IMAP disabled no

# POP3 (Port 110)
set rulebase nat rules Inbound-POP3 destination-translation translated-address 192.168.100.3
set rulebase nat rules Inbound-POP3 destination-translation translated-port 110
set rulebase nat rules Inbound-POP3 to Internet
set rulebase nat rules Inbound-POP3 from Internet
set rulebase nat rules Inbound-POP3 source any
set rulebase nat rules Inbound-POP3 destination 64.124.41.198
set rulebase nat rules Inbound-POP3 service POP3
set rulebase nat rules Inbound-POP3 to-interface ethernet1/2
set rulebase nat rules Inbound-POP3 disabled no

# POP3 Secure (Port 995)
set rulebase nat rules Inbound-POP3S destination-translation translated-address 192.168.100.3
set rulebase nat rules Inbound-POP3S destination-translation translated-port 995
set rulebase nat rules Inbound-POP3S to Internet
set rulebase nat rules Inbound-POP3S from Internet
set rulebase nat rules Inbound-POP3S source any
set rulebase nat rules Inbound-POP3S destination 64.124.41.198
set rulebase nat rules Inbound-POP3S service POP3-Secure
set rulebase nat rules Inbound-POP3S to-interface ethernet1/2
set rulebase nat rules Inbound-POP3S disabled no

# IMAP with TLS (Port 143)
set rulebase nat rules Inbound-IMAP-TLS destination-translation translated-address 192.168.100.3
set rulebase nat rules Inbound-IMAP-TLS destination-translation translated-port 143
set rulebase nat rules Inbound-IMAP-TLS to Internet
set rulebase nat rules Inbound-IMAP-TLS from Internet
set rulebase nat rules Inbound-IMAP-TLS source any
set rulebase nat rules Inbound-IMAP-TLS destination 64.124.41.198
set rulebase nat rules Inbound-IMAP-TLS service IMAP-TLS
set rulebase nat rules Inbound-IMAP-TLS to-interface ethernet1/2
set rulebase nat rules Inbound-IMAP-TLS disabled no

# SharePoint HTTPS (Port 444)
set rulebase nat rules Inbound-SharePoint destination-translation translated-address 192.168.100.5
set rulebase nat rules Inbound-SharePoint destination-translation translated-port 443
set rulebase nat rules Inbound-SharePoint to Internet
set rulebase nat rules Inbound-SharePoint from Internet
set rulebase nat rules Inbound-SharePoint source any
set rulebase nat rules Inbound-SharePoint destination 64.124.41.198
set rulebase nat rules Inbound-SharePoint service SharePoint-HTTPS
set rulebase nat rules Inbound-SharePoint to-interface ethernet1/2
set rulebase nat rules Inbound-SharePoint disabled no

# ============================================================================
# Security Policy
# ============================================================================

# Security Rule 1: Block Geo-Location Threats (Inbound)
# Block connections from high-risk countries
set rulebase security rules Block-GeoLocation-Threats to any
set rulebase security rules Block-GeoLocation-Threats from Internet
set rulebase security rules Block-GeoLocation-Threats source [ GEO_LIST ]
set rulebase security rules Block-GeoLocation-Threats destination any
set rulebase security rules Block-GeoLocation-Threats application any
set rulebase security rules Block-GeoLocation-Threats service any
set rulebase security rules Block-GeoLocation-Threats action drop
set rulebase security rules Block-GeoLocation-Threats log-end yes

# Security Rule 2: Block Known Malicious IPs (Inbound)
# Block connections from Palo Alto threat intelligence feeds
set rulebase security rules Block-Malicious-IPs-Inbound to any
set rulebase security rules Block-Malicious-IPs-Inbound from Internet
set rulebase security rules Block-Malicious-IPs-Inbound source [ panw-highrisk-ip-list panw-known-ip-list ]
set rulebase security rules Block-Malicious-IPs-Inbound destination any
set rulebase security rules Block-Malicious-IPs-Inbound application any
set rulebase security rules Block-Malicious-IPs-Inbound service any
set rulebase security rules Block-Malicious-IPs-Inbound action drop
set rulebase security rules Block-Malicious-IPs-Inbound log-end yes

# Security Rule 3: Block Known Malicious IPs (Outbound)
# Prevent DMZ from connecting to known bad destinations
set rulebase security rules Block-Malicious-IPs-Outbound to any
set rulebase security rules Block-Malicious-IPs-Outbound from DMZ
set rulebase security rules Block-Malicious-IPs-Outbound source any
set rulebase security rules Block-Malicious-IPs-Outbound destination [ panw-highrisk-ip-list panw-known-ip-list ]
set rulebase security rules Block-Malicious-IPs-Outbound application any
set rulebase security rules Block-Malicious-IPs-Outbound service any
set rulebase security rules Block-Malicious-IPs-Outbound action drop
set rulebase security rules Block-Malicious-IPs-Outbound log-end yes

# Security Rule 4: Allow Outbound from DMZ to Internet
# Allows M365 servers to access internet (Windows Update, etc.)
set rulebase security rules Allow-Outbound-DMZ to Internet
set rulebase security rules Allow-Outbound-DMZ from DMZ
set rulebase security rules Allow-Outbound-DMZ source any
set rulebase security rules Allow-Outbound-DMZ destination any
set rulebase security rules Allow-Outbound-DMZ application any
set rulebase security rules Allow-Outbound-DMZ service any
set rulebase security rules Allow-Outbound-DMZ action allow
set rulebase security rules Allow-Outbound-DMZ log-end yes

# Security Rule 5: Allow SMTP Inbound (with threat prevention)
# Email submission from internet
set rulebase security rules Allow-SMTP-Inbound profile-setting profiles virus default
set rulebase security rules Allow-SMTP-Inbound profile-setting profiles spyware strict
set rulebase security rules Allow-SMTP-Inbound profile-setting profiles vulnerability strict
set rulebase security rules Allow-SMTP-Inbound to DMZ
set rulebase security rules Allow-SMTP-Inbound from Internet
set rulebase security rules Allow-SMTP-Inbound source any
set rulebase security rules Allow-SMTP-Inbound destination 64.124.41.198
set rulebase security rules Allow-SMTP-Inbound application smtp
set rulebase security rules Allow-SMTP-Inbound service application-default
set rulebase security rules Allow-SMTP-Inbound action allow
set rulebase security rules Allow-SMTP-Inbound log-end yes
set rulebase security rules Allow-SMTP-Inbound disabled no

# Security Rule 6: Allow OWA/HTTPS Inbound (with threat prevention)
# Outlook Web Access and other HTTPS services
set rulebase security rules Allow-OWA-Inbound profile-setting profiles virus default
set rulebase security rules Allow-OWA-Inbound profile-setting profiles spyware strict
set rulebase security rules Allow-OWA-Inbound profile-setting profiles vulnerability strict
set rulebase security rules Allow-OWA-Inbound to DMZ
set rulebase security rules Allow-OWA-Inbound from Internet
set rulebase security rules Allow-OWA-Inbound source any
set rulebase security rules Allow-OWA-Inbound destination 64.124.41.198
set rulebase security rules Allow-OWA-Inbound application any
set rulebase security rules Allow-OWA-Inbound service service-https
set rulebase security rules Allow-OWA-Inbound action allow
set rulebase security rules Allow-OWA-Inbound log-end yes
set rulebase security rules Allow-OWA-Inbound disabled no

# Security Rule 7: Allow IMAP Inbound (with threat prevention)
# IMAP email access
set rulebase security rules Allow-IMAP-Inbound profile-setting profiles virus default
set rulebase security rules Allow-IMAP-Inbound profile-setting profiles spyware strict
set rulebase security rules Allow-IMAP-Inbound profile-setting profiles vulnerability strict
set rulebase security rules Allow-IMAP-Inbound to DMZ
set rulebase security rules Allow-IMAP-Inbound from Internet
set rulebase security rules Allow-IMAP-Inbound source any
set rulebase security rules Allow-IMAP-Inbound destination 64.124.41.198
set rulebase security rules Allow-IMAP-Inbound application any
set rulebase security rules Allow-IMAP-Inbound service IMAP
set rulebase security rules Allow-IMAP-Inbound action allow
set rulebase security rules Allow-IMAP-Inbound log-end yes
set rulebase security rules Allow-IMAP-Inbound disabled no

# Security Rule 8: Allow POP3 Inbound (with threat prevention)
# POP3 email access
set rulebase security rules Allow-POP3-Inbound profile-setting profiles virus default
set rulebase security rules Allow-POP3-Inbound profile-setting profiles spyware strict
set rulebase security rules Allow-POP3-Inbound profile-setting profiles vulnerability strict
set rulebase security rules Allow-POP3-Inbound to DMZ
set rulebase security rules Allow-POP3-Inbound from Internet
set rulebase security rules Allow-POP3-Inbound source any
set rulebase security rules Allow-POP3-Inbound destination 64.124.41.198
set rulebase security rules Allow-POP3-Inbound application any
set rulebase security rules Allow-POP3-Inbound service POP3
set rulebase security rules Allow-POP3-Inbound action allow
set rulebase security rules Allow-POP3-Inbound log-end yes
set rulebase security rules Allow-POP3-Inbound disabled no

# Security Rule 9: Allow SharePoint Inbound (with threat prevention)
# SharePoint web access
set rulebase security rules Allow-SharePoint-Inbound profile-setting profiles virus default
set rulebase security rules Allow-SharePoint-Inbound profile-setting profiles spyware strict
set rulebase security rules Allow-SharePoint-Inbound profile-setting profiles vulnerability strict
set rulebase security rules Allow-SharePoint-Inbound to DMZ
set rulebase security rules Allow-SharePoint-Inbound from Internet
set rulebase security rules Allow-SharePoint-Inbound source any
set rulebase security rules Allow-SharePoint-Inbound destination 64.124.41.198
set rulebase security rules Allow-SharePoint-Inbound application any
set rulebase security rules Allow-SharePoint-Inbound service SharePoint-HTTPS
set rulebase security rules Allow-SharePoint-Inbound action allow
set rulebase security rules Allow-SharePoint-Inbound log-end yes
set rulebase security rules Allow-SharePoint-Inbound disabled no

# Security Rule 10: Default Deny and Log
# Catch-all rule to log and deny all other traffic
set rulebase security rules Default-Deny-Log to any
set rulebase security rules Default-Deny-Log from Internet
set rulebase security rules Default-Deny-Log source any
set rulebase security rules Default-Deny-Log destination any
set rulebase security rules Default-Deny-Log application any
set rulebase security rules Default-Deny-Log service any
set rulebase security rules Default-Deny-Log action deny
set rulebase security rules Default-Deny-Log log-end yes

# ============================================================================
# Configuration Notes
# ============================================================================

# 1. IP Address Replacements:
#    - Replace 64.124.41.198 with your actual public IP for M365 services
#    - Replace 64.124.41.197/29 with your actual public IP block
#    - Replace 64.124.41.193 with your actual internet gateway IP
#
# 2. F5 Load Balancer VIPs (in DMZ VLAN 500):
#    - 192.168.100.2: F5 Load Balancer self-IP
#    - 192.168.100.3: Virtual IP for OWA/Mailbox services
#    - 192.168.100.4: Virtual IP for SMTP/Edge Transport services
#    - 192.168.100.5: Virtual IP for SharePoint services
#
# 3. Security Considerations:
#    - All inbound rules include threat prevention profiles
#    - Geo-blocking is enabled for high-risk countries (customize as needed)
#    - Outbound traffic from DMZ is allowed but logged
#    - Default deny rule at the end catches all unmatched traffic
#
# 4. Logging:
#    - All security rules log at session end
#    - Configure syslog server for centralized logging
#    - Monitor logs regularly for security events
#
# 5. High Availability:
#    - This is a single firewall configuration
#    - For production, deploy in HA pair with active/passive or active/active
#    - Synchronize configuration between HA peers
#
# 6. Performance Tuning:
#    - Adjust threat prevention profiles based on performance requirements
#    - Monitor CPU and memory usage
#    - Size VM appropriately for expected traffic load

# End of Configuration
