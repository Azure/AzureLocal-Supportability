# Troubleshoot-Test-SLB_ValidateSoftwareLoadBalancer

<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse; margin-bottom:1em;">
    <tr>
        <th style="text-align:left; width: 180px;">Name</th>
        <td><strong>SLB_ValidateSoftwareLoadBalancer</strong></td>
    </tr>
    <tr>
        <th style="text-align:left; width: 180px;">Severity</th>
        <td><strong>Critical</strong>: This validator will block operations until remediated.</td>
    </tr>
    <tr>
        <th style="text-align:left;width: 180px;">Applicable Scenarios</th>
        <td><strong>Deployment</strong></td>
    </tr>
</table>

## Overview

The `Test-SLB_ValidateSoftwareLoadBalancer` function checks the Software Load Balancer (SLB) configuration in your Azure Local environment for completeness and correctness. It verifies that all required properties—such as `NumberOfMuxes` and `BGPInfo` (including `LocalASN` and `PeerRouterConfigurations`) are present and set to valid values. Within the Border Gateway Protocol(BGP) section, both the local and peer Autonomous System Numbers (ASN) must be valid, and each peer router must have a unique, properly formatted IPv4 address. The validator ensures the configuration meets criteria for load balancing, high availability, and network reliability. If any property is missing, invalid, or duplicated, the function returns a failure result with details for remediation. Use this validator to proactively detect and resolve SLB configuration issues before they impact your environment.

## Example Configuration

This following describes the BGP (Border Gateway Protocol) configuration for a Software Load Balancer (SLB) in Azure Local environments. Here’s a breakdown of each part:

```text
- SoftwareLoadBalancer: The main object representing the SLB.
    - NumberOfMuxes: Placeholder for the number of MUX (multiplexer) instances in your SLB deployment.
    - BGPInfo: Contains BGP-specific settings.
        - LocalASN: Placeholder for the Autonomous System Number (ASN) assigned to the SLB itself.
        - PeerRouterConfigurations: An array listing each BGP peer router.
            - PeerASN: The ASN of the peer router.
            - RouterIPAddress: The IP address of the peer router.

```

This example illustrates a 'SoftwareLoadBalancer' configuration, emphasizing the key properties and structure required for a network utilizing SoftwareLoadBalancer. Refer to this sample to confirm your configuration contains all mandatory fields and adheres to the expected format.

```json
{
    "SoftwareLoadBalancer": {
        "NumberOfMuxes": <Specify the total number of MUX instances>,
        "BGPInfo": {
            "LocalASN": <Enter the local ASN for the SLB>,
            "PeerRouterConfigurations": [
                {
                    "PeerASN": <Enter ASN for Peer 1>,
                    "RouterIPAddress": "<Enter IP address for Peer 1 router>"
                },
                {
                    "PeerASN": <Enter ASN for Peer 2>,
                    "RouterIPAddress": "<Enter IP address for Peer 2 router>"
                }
            ]
        }
    }
}
```

Ensure all required properties in your `SoftwareLoadBalancer` configuration object are present and correctly formatted. Specifically, verify that:

```text
- `NumberOfMuxes` is an integer between 1 and 3.
- `BGPInfo` is present and includes:
    - `LocalASN` (integer between 0 and 4294967295)
    - `PeerRouterConfigurations` (array with at least one entry), and for each entry:
        - `PeerASN` (integer between 0 and 4294967295)
        - `RouterIPAddress` (valid IPv4 address, unique per entry)
```

---
## Requirements

- An Azure Local environment is deployed and accessible.
- The `AzStackHci` PowerShell module is installed and imported.
- You have sufficient permissions to query and modify Software Load Balancer (SLB) nodes and Multiplexer (MUX) instances.
- All target hosts are online and reachable from the management system.
- You have administrative privileges on both the management system and all target hosts.

## Troubleshooting Steps

### Review Environment Validator Output

- Run the `Test-SLB_ValidateSoftwareLoadBalancer` validator and capture its result object.
- Identify result entries generated by `Test-SLB_ValidateSoftwareLoadBalancer` (check Name, DisplayName, or Source).
- For each failed or warning entry, inspect `AdditionalData.Detail` (and TimeStamp/Resource) to see the example message and context.
- Match the `Detail` text to the Failure Results below and apply the recommended remediation steps.
- Example output: The following is a sample output you should expect after running the command. Use this to verify that the command executed successfully and to compare your results.

```json
{
    "Name":  "AzStackHci_NetworkSLB_Test-SLB_ValidateSoftwareLoadBalancer",
    "DisplayName":  "Check Software Load Balancer (SLB) configuration is present and valid",
    "Tags":  {},
    "Title":  "Check Software Load Balancer (SLB) configuration is present and valid",
    "Status":  1,
    "Severity":  2,
    "Description":  "Test if we have valid SoftwareLoadBalancer configuration",
    "Remediation":  "https://github.com/kybeak/AzureLocal-Supportability/blob/user/kybeak/first/TSG/EnvironmentValidator/SLB/Troubleshoot-Test-SLB_ValidateSoftwareLoadBalancer.md",
    "TargetResourceID":  "Property name: RouterIPAddress, value: ",
    "TargetResourceName":  "RouterIPAddress",
    "TargetResourceType":  "SoftwareLoadBalancer",
    "Timestamp":  "\/Date(1761004281682)\/",
    "AdditionalData":  {
                        "Detail":  "\"SoftwareLoadBalancer does not have a valid [RouterIPAddress = ] defined. Please ensure a valid [RouterIPAddress] is configured for the SoftwareLoadBalancer.\"",
                        "Status":  "FAILURE",
                        "TimeStamp":  "10/20/2025 23:51:21",
                        "Resource":  "SoftwareLoadBalancer",
                        "Source":  "SDNIntegration"
                        },
    "HealthCheckSource":  "Deployment\\Standard\\Medium\\NetworkSLB\\073ad76b"
}
```

### Failure Results

The following section lists all potential failure results returned by `Test-SLB_ValidateSoftwareLoadBalancer`. For each failure type, you will find example messages from the `AdditionalData.Detail` field and specific remediation steps to address the issue.

---

#### Failure: NumberOfMuxes is missing or out of supported range

**Description:**  

The `NumberOfMuxes` property is missing, empty, less than 1, or greater than 3.

**Additional Data Example:**

```text
Detail    : SoftwareLoadBalancer does not have a valid [NumberOfMuxes = 0] defined. Please ensure a valid [NumberOfMuxes] is configured for the SoftwareLoadBalancer.
Status    : FAILURE
TimeStamp : <timestamp>
Resource  : SoftwareLoadBalancer
Source    : SDNIntegration
```

**Remediation Steps:**  

Set `NumberOfMuxes` to a value between 1 and 3.

---

#### Failure: BGPInfo is missing

**Description:**  

The `BGPInfo` property is missing or empty.

**Additional Data Example:**

```text
Detail    : SoftwareLoadBalancer does not have a valid [BGPInfo = <NULL>] defined. Please ensure a valid [BGPInfo] is configured for the SoftwareLoadBalancer.
Status    : FAILURE
TimeStamp : <timestamp>
Resource  : SoftwareLoadBalancer
Source    : SDNIntegration
```

**Remediation Steps:**  

Ensure the `BGPInfo` property is present and properly configured.

---

#### Failure: LocalASN is missing or out of valid range

**Description:**  

The `LocalASN` property in `BGPInfo` is missing, empty, or not within the valid ASN range (0–4294967295).

```text
Detail    : SoftwareLoadBalancer does not have a valid [LocalASN = -1] defined. Please ensure a valid [LocalASN] is configured for the SoftwareLoadBalancer.
Status    : FAILURE
TimeStamp : <timestamp>
Resource  : SoftwareLoadBalancer
Source    : SDNIntegration
```

**Remediation Steps:**  

Set `LocalASN` to a valid ASN value between 0 and 4294967295.

---

#### Failure: PeerRouterConfigurations is missing or empty

**Description:**  

The `PeerRouterConfigurations` array in `BGPInfo` is missing or contains no entries.

**Additional Data Example:**

```text
Detail    : SoftwareLoadBalancer does not have a valid [PeerRouterConfigurations = <NULL>] defined. Please ensure a valid [PeerRouterConfigurations] is configured for the SoftwareLoadBalancer.
Status    : FAILURE
TimeStamp : <timestamp>
Resource  : SoftwareLoadBalancer
Source    : SDNIntegration
```

**Remediation Steps:**  

Add at least one valid peer router configuration to `PeerRouterConfigurations`.

---

#### Failure: PeerASN is missing or out of valid range

**Description:**  

A `PeerASN` value in `PeerRouterConfigurations` is missing, empty, or not within the valid ASN range (0–4294967295).

**Additional Data Example:**

```text
Detail    : SoftwareLoadBalancer does not have a valid [PeerASN = -1] defined. Please ensure a valid [PeerASN] is configured for the SoftwareLoadBalancer.
Status    : FAILURE
TimeStamp : <timestamp>
Resource  : SoftwareLoadBalancer
Source    : SDNIntegration
```

**Remediation Steps:**  

Set `PeerASN` to a valid ASN value between 0 and 4294967295 for each peer.

---

#### Failure: RouterIPAddress is missing or not a valid IPv4 address

**Description:**  

A `RouterIPAddress` value in `PeerRouterConfigurations` is missing, empty, or not a valid IPv4 address.

**Additional Data Example:**

```text
Detail    : SoftwareLoadBalancer does not have a valid [RouterIPAddress = <NULL>] defined. Please ensure a valid [RouterIPAddress] is configured for the SoftwareLoadBalancer.
Status    : FAILURE
TimeStamp : <timestamp>
Resource  : SoftwareLoadBalancer
Source    : SDNIntegration
```

**Remediation Steps:**  

Provide a valid IPv4 address for each peer router.

---

#### Failure: Duplicate RouterIPAddress detected

**Description:**  

Multiple entries in `PeerRouterConfigurations` have the same `RouterIPAddress`.

**Additional Data Example:**

```text
Detail    : The [RouterIPAddress] of SoftwareLoadBalancer has duplicated IP address [x.x.x.x].
Status    : FAILURE
TimeStamp : <timestamp>
Resource  : SoftwareLoadBalancer
Source    : SDNIntegration
```

**Remediation Steps:**  

Ensure each `RouterIPAddress` in `PeerRouterConfigurations` is unique.
